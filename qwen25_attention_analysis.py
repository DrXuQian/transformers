"""
Qwen2.5-VL æ³¨æ„åŠ›æœºåˆ¶æ·±åº¦åˆ†æ
è¯æ˜ï¼š"å…¨æ³¨æ„åŠ›"å±‚å®é™…ä¸Šä¹Ÿæ˜¯åˆ†æ‰¹å¤„ç†çš„
"""

def analyze_qwen25_attention():
    """
    åˆ†æQwen2.5-VLçš„æ³¨æ„åŠ›æœºåˆ¶å®ç°
    """

    print("=" * 80)
    print("Qwen2.5-VL æ³¨æ„åŠ›æœºåˆ¶çœŸç›¸æ­ç§˜")
    print("=" * 80)

    # 1. cu_seqlensçš„ç”Ÿæˆ
    print("\n1. cu_seqlens çš„ç”Ÿæˆé€»è¾‘")
    print("-" * 40)
    print("""
    # modeling_qwen2_5_vl.py:439-446
    cu_seqlens = torch.repeat_interleave(
        grid_thw[:, 1] * grid_thw[:, 2],  # æ¯ä¸ªå›¾åƒ/è§†é¢‘çš„H*W
        grid_thw[:, 0]                     # é‡å¤Tæ¬¡ï¼ˆæ—¶é—´ç»´åº¦ï¼‰
    ).cumsum(dim=0)

    # ä¾‹å¦‚ï¼Œå¦‚æœæœ‰2ä¸ªå›¾åƒï¼š
    # å›¾åƒ1: grid_thw[0] = [1, 28, 28] -> H*W=784, T=1
    # å›¾åƒ2: grid_thw[1] = [1, 28, 28] -> H*W=784, T=1
    # cu_seqlens = [0, 784, 1568]
    # è¡¨ç¤ºç¬¬ä¸€ä¸ªåºåˆ—æ˜¯[0:784]ï¼Œç¬¬äºŒä¸ªåºåˆ—æ˜¯[784:1568]
    """)

    # 2. "å…¨æ³¨æ„åŠ›"å±‚çš„å¤„ç†
    print("\n2. 'å…¨æ³¨æ„åŠ›'å±‚çš„å®é™…è¡Œä¸º")
    print("-" * 40)
    print("""
    # modeling_qwen2_5_vl.py:449-453
    for layer_num, blk in enumerate(self.blocks):
        if layer_num in self.fullatt_block_indexes:  # [7, 15, 23, 31]
            cu_seqlens_now = cu_seqlens           # ä½¿ç”¨åŸå§‹åºåˆ—è¾¹ç•Œ
        else:
            cu_seqlens_now = cu_window_seqlens    # ä½¿ç”¨çª—å£åºåˆ—è¾¹ç•Œ

        hidden_states = blk(
            hidden_states,
            cu_seqlens=cu_seqlens_now,  # ä¼ å…¥åºåˆ—è¾¹ç•Œ
            ...
        )
    """)

    # 3. æ³¨æ„åŠ›è®¡ç®—çš„å…³é”®ä»£ç 
    print("\n3. æ³¨æ„åŠ›è®¡ç®—çš„å®é™…å®ç°")
    print("-" * 40)
    print("""
    # modeling_qwen2_5_vl.py:237-258 (éFlash Attentionå®ç°)

    # è®¡ç®—æ¯ä¸ªåºåˆ—çš„é•¿åº¦
    lengths = cu_seqlens[1:] - cu_seqlens[:-1]  # [784, 784]

    # æŒ‰åºåˆ—é•¿åº¦åˆ‡åˆ†Q, K, V
    splits = [
        torch.split(tensor, lengths.tolist(), dim=2)
        for tensor in (query_states, key_states, value_states)
    ]

    # ğŸ”¥ å…³é”®ï¼šæ¯ä¸ªåºåˆ—ç‹¬ç«‹è®¡ç®—æ³¨æ„åŠ›ï¼
    attn_outputs = [
        attention_interface(
            q, k, v,  # æ¯ä¸ªåºåˆ—å•ç‹¬çš„Q, K, V
            attention_mask=None,
            ...
        )
        for q, k, v in zip(*splits)  # éå†æ¯ä¸ªåºåˆ—
    ]

    # æœ€åæ‹¼æ¥ç»“æœ
    attn_output = torch.cat(attn_outputs, dim=1)
    """)

    # 4. Flash Attention 2çš„å®ç°
    print("\n4. Flash Attention 2 çš„å¤„ç†")
    print("-" * 40)
    print("""
    # modeling_qwen2_5_vl.py:219-236
    if self.config._attn_implementation == "flash_attention_2":
        attn_output, _ = attention_interface(
            ...,
            cu_seq_lens_q=cu_seqlens,  # ğŸ”¥ ä¼ å…¥åºåˆ—è¾¹ç•Œ
            cu_seq_lens_k=cu_seqlens,  # ğŸ”¥ Flash Attentionå†…éƒ¨æŒ‰è¾¹ç•Œå¤„ç†
            ...
        )

    Flash Attention 2 ä½¿ç”¨cu_seqlensæ¥çŸ¥é“åºåˆ—è¾¹ç•Œï¼Œ
    å†…éƒ¨å®ç°ä¼šé˜»æ­¢è·¨åºåˆ—çš„æ³¨æ„åŠ›è®¡ç®—ï¼
    """)

    # 5. å…³é”®å‘ç°
    print("\nğŸ”¥ å…³é”®å‘ç°")
    print("=" * 80)
    print("""
    å³ä½¿åœ¨æ‰€è°“çš„"å…¨æ³¨æ„åŠ›"å±‚ï¼ˆfullatt_block_indexesï¼‰ï¼ŒQwen2.5-VLå®é™…ä¸Šï¼š

    1. ä»ç„¶ä½¿ç”¨cu_seqlensåˆ’åˆ†åºåˆ—è¾¹ç•Œ
    2. æ¯ä¸ªåºåˆ—ï¼ˆå›¾åƒ/è§†é¢‘å¸§ï¼‰ç‹¬ç«‹è®¡ç®—æ³¨æ„åŠ›
    3. ä¸å­˜åœ¨è·¨åºåˆ—ï¼ˆè·¨å›¾åƒï¼‰çš„æ³¨æ„åŠ›äº¤äº’

    åŒºåˆ«ä»…åœ¨äºï¼š
    - çª—å£æ³¨æ„åŠ›å±‚ï¼šåºåˆ—å†…éƒ¨å†åˆ†æˆå¤šä¸ªçª—å£ï¼Œçª—å£é—´æ— äº¤äº’
    - "å…¨æ³¨æ„åŠ›"å±‚ï¼šåºåˆ—å†…éƒ¨ä¸åˆ†çª—å£ï¼Œä½†åºåˆ—é—´ä»æ— äº¤äº’
    """)

    # 6. ä¸Qwen3-VLçš„å¯¹æ¯”
    print("\n6. ä¸Qwen3-VLçš„çœŸæ­£åŒºåˆ«")
    print("-" * 40)
    print("""
    Qwen3-VL:
    - çœŸæ­£çš„å…¨æ³¨æ„åŠ›ï¼šæ‰€æœ‰tokenä¹‹é—´éƒ½å¯ä»¥äº¤äº’
    - æ²¡æœ‰cu_seqlensæœºåˆ¶
    - è®¡ç®—å¤æ‚åº¦ï¼šO(NÂ²)ï¼ŒNæ˜¯æ€»tokenæ•°

    Qwen2.5-VL:
    - æ‰¹å¤„ç†çš„"å…¨æ³¨æ„åŠ›"ï¼šåªåœ¨å•ä¸ªåºåˆ—å†…å…¨æ³¨æ„åŠ›
    - ä½¿ç”¨cu_seqlenséš”ç¦»ä¸åŒåºåˆ—
    - è®¡ç®—å¤æ‚åº¦ï¼šO(K * MÂ²)ï¼ŒKæ˜¯åºåˆ—æ•°ï¼ŒMæ˜¯å•åºåˆ—é•¿åº¦
    - æ•ˆç‡æ›´é«˜ï¼Œä½†ç¼ºå°‘è·¨å›¾åƒ/è·¨è§†é¢‘çš„å…¨å±€ç†è§£
    """)

    # 7. å®ä¾‹è¯´æ˜
    print("\n7. å…·ä½“å®ä¾‹")
    print("-" * 40)
    print("""
    å‡è®¾è¾“å…¥2å¼ å›¾ç‰‡ï¼Œæ¯å¼ 28x28=784ä¸ªtokenï¼š

    Qwen3-VLçš„å¤„ç†ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æ‰€æœ‰1568ä¸ªtokenä¹‹é—´éƒ½å¯ä»¥æ³¨æ„åŠ›äº¤äº’  â”‚
    â”‚  å›¾ç‰‡1 â†â†’ å›¾ç‰‡1 âœ“                   â”‚
    â”‚  å›¾ç‰‡1 â†â†’ å›¾ç‰‡2 âœ“                   â”‚
    â”‚  å›¾ç‰‡2 â†â†’ å›¾ç‰‡2 âœ“                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Qwen2.5-VLçš„"å…¨æ³¨æ„åŠ›"å±‚ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  åºåˆ—1 (0:784)    åºåˆ—2 (784:1568)  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
    â”‚  â”‚å›¾ç‰‡1å†…éƒ¨ â”‚     â”‚å›¾ç‰‡2å†…éƒ¨ â”‚     â”‚
    â”‚  â”‚å…¨æ³¨æ„åŠ›âœ“â”‚     â”‚å…¨æ³¨æ„åŠ›âœ“â”‚     â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
    â”‚      â†‘ âœ— æ— äº¤äº’ âœ— â†“                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """)

    # 8. ä»£ç è¯æ®æ€»ç»“
    print("\n8. ä»£ç è¯æ®æ€»ç»“")
    print("=" * 80)
    print("""
    å…³é”®ä»£ç ä½ç½®ï¼š
    1. cu_seqlensç”Ÿæˆ: line 439-446
    2. åºåˆ—åˆ†å‰²: line 239-242
    3. ç‹¬ç«‹æ³¨æ„åŠ›è®¡ç®—: line 244-257
    4. Flash Attentionè¾¹ç•Œ: line 230-231

    ç»“è®ºï¼šQwen2.5-VLçš„"å…¨æ³¨æ„åŠ›"å±‚åä¸å‰¯å®ï¼Œ
    å®é™…æ˜¯"åºåˆ—å†…å…¨æ³¨æ„åŠ›ï¼Œåºåˆ—é—´æ— æ³¨æ„åŠ›"ã€‚
    """)

    print("\n" + "=" * 80)
    print("âœ… åˆ†æå®Œæˆï¼šç”¨æˆ·çš„è´¨ç–‘æ˜¯æ­£ç¡®çš„ï¼")
    print("   Qwen2.5-VLçš„4å±‚'å…¨æ³¨æ„åŠ›'ç¡®å®ä¹Ÿæ˜¯åˆ†åºåˆ—å¤„ç†çš„ã€‚")
    print("=" * 80)


def visualize_attention_patterns():
    """
    å¯è§†åŒ–ä¸¤ç§æ¨¡å‹çš„æ³¨æ„åŠ›æ¨¡å¼å·®å¼‚
    """
    print("\n\næ³¨æ„åŠ›æ¨¡å¼å¯è§†åŒ–")
    print("=" * 80)

    visual = """
    è¾“å…¥: 4å¼ å›¾ç‰‡ï¼Œæ¯å¼ 4x4=16ä¸ªtokenï¼Œæ€»å…±64ä¸ªtoken

    Qwen3-VL çœŸÂ·å…¨æ³¨æ„åŠ› (64Ã—64çŸ©é˜µ):
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â”‚ å›¾1â†’æ‰€æœ‰
    â”‚â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â”‚
    â”‚â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â”‚
    â”‚â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â”‚
    â”‚â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â”‚ å›¾2â†’æ‰€æœ‰
    â”‚â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â”‚
    â”‚â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â”‚
    â”‚â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â”‚
    â”‚â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â”‚ å›¾3â†’æ‰€æœ‰
    â”‚â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â”‚
    â”‚â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â”‚
    â”‚â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â”‚
    â”‚â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â”‚ å›¾4â†’æ‰€æœ‰
    â”‚â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â”‚
    â”‚â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â”‚
    â”‚â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Qwen2.5-VL "å…¨æ³¨æ„åŠ›"å±‚ (4ä¸ª16Ã—16çŸ©é˜µ):
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚â– â– â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â”‚ å›¾1â†’å›¾1 âœ“
    â”‚â– â– â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â”‚
    â”‚â– â– â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â”‚
    â”‚â– â– â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â”‚
    â”‚â–¡â–¡â–¡â–¡â– â– â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â”‚ å›¾2â†’å›¾2 âœ“
    â”‚â–¡â–¡â–¡â–¡â– â– â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â”‚
    â”‚â–¡â–¡â–¡â–¡â– â– â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â”‚
    â”‚â–¡â–¡â–¡â–¡â– â– â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â”‚
    â”‚â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â– â– â– â– â–¡â–¡â–¡â–¡â”‚ å›¾3â†’å›¾3 âœ“
    â”‚â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â– â– â– â– â–¡â–¡â–¡â–¡â”‚
    â”‚â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â– â– â– â– â–¡â–¡â–¡â–¡â”‚
    â”‚â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â– â– â– â– â–¡â–¡â–¡â–¡â”‚
    â”‚â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â– â– â– â– â”‚ å›¾4â†’å›¾4 âœ“
    â”‚â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â– â– â– â– â”‚
    â”‚â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â– â– â– â– â”‚
    â”‚â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â– â– â– â– â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â–  = æœ‰æ³¨æ„åŠ›äº¤äº’
    â–¡ = æ— æ³¨æ„åŠ›äº¤äº’ï¼ˆè¢«cu_seqlensé˜»æ–­ï¼‰

    Qwen2.5-VL çª—å£æ³¨æ„åŠ›å±‚ (æ›´ç»†ç²’åº¦åˆ†å—):
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â”‚ å›¾1çª—å£1â†’çª—å£1
    â”‚â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â”‚
    â”‚â–¡â–¡â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â”‚ å›¾1çª—å£2â†’çª—å£2
    â”‚â–¡â–¡â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â”‚
    â”‚â–¡â–¡â–¡â–¡â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â”‚ å›¾2çª—å£1â†’çª—å£1
    â”‚â–¡â–¡â–¡â–¡â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â”‚
    â”‚â–¡â–¡â–¡â–¡â–¡â–¡â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â”‚ å›¾2çª—å£2â†’çª—å£2
    â”‚â–¡â–¡â–¡â–¡â–¡â–¡â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â”‚
    â”‚... æ›´å¤šçª—å£ ...â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """

    print(visual)


if __name__ == "__main__":
    # è¿è¡Œåˆ†æ
    analyze_qwen25_attention()

    # å¯è§†åŒ–
    visualize_attention_patterns()