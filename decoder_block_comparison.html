<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qwen3-VL vs Qwen2.5-VL Decoder Block ç»“æ„å¯¹æ¯”</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .content {
            padding: 40px;
        }

        .decoder-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        .decoder-block {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #e0e0e0;
        }

        .block-title {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .qwen3-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .qwen25-title {
            background: linear-gradient(135deg, #06beb6 0%, #48b1bf 100%);
        }

        svg {
            width: 100%;
            height: auto;
        }

        /* Component styles */
        .input-box {
            fill: #e8f5e9;
            stroke: #4caf50;
            stroke-width: 2;
        }

        .norm-box {
            fill: #fff3e0;
            stroke: #ff9800;
            stroke-width: 2;
        }

        .attention-box {
            fill: #e3f2fd;
            stroke: #2196f3;
            stroke-width: 2;
        }

        .mlp-box {
            fill: #f3e5f5;
            stroke: #9c27b0;
            stroke-width: 2;
        }

        .special-box {
            fill: #ffebee;
            stroke: #f44336;
            stroke-width: 2;
        }

        .output-box {
            fill: #e0f2f1;
            stroke: #009688;
            stroke-width: 2;
        }

        .arrow {
            stroke: #555;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .skip-connection {
            stroke: #4caf50;
            stroke-width: 2;
            fill: none;
            stroke-dasharray: 5,5;
            marker-end: url(#arrowhead-green);
        }

        .deepstack-connection {
            stroke: #ff5722;
            stroke-width: 2;
            fill: none;
            stroke-dasharray: 3,3;
            marker-end: url(#arrowhead-red);
        }

        .param-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .param-table th {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .param-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .param-table tr:hover {
            background: #f5f5f5;
        }

        .formula-box {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }

        .formula {
            font-family: 'Courier New', monospace;
            color: #333;
            margin: 10px 0;
        }

        .highlight-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 30px;
        }

        .feature-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .feature-card h3 {
            color: #1e3c72;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .feature-card p {
            color: #666;
            line-height: 1.6;
            font-size: 0.95em;
        }

        .code-snippet {
            background: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            overflow-x: auto;
        }

        .code-snippet code {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ—ï¸ Decoder Block æ¶æ„å¯¹æ¯”</h1>
            <p>Qwen3-VL vs Qwen2.5-VL LLMå±‚ç»“æ„è¯¦è§£</p>
        </div>

        <div class="content">
            <!-- Decoder Block å¯¹æ¯”å›¾ -->
            <div class="decoder-comparison">
                <!-- Qwen3-VL Decoder Block -->
                <div class="decoder-block">
                    <div class="block-title qwen3-title">Qwen3-VL Decoder Layer</div>
                    <svg viewBox="0 0 400 900" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7"
                                    refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#555" />
                            </marker>
                            <marker id="arrowhead-green" markerWidth="10" markerHeight="7"
                                    refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#4caf50" />
                            </marker>
                            <marker id="arrowhead-red" markerWidth="10" markerHeight="7"
                                    refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#ff5722" />
                            </marker>
                        </defs>

                        <!-- Input -->
                        <rect x="100" y="20" width="200" height="40" class="input-box" rx="5"/>
                        <text x="200" y="45" text-anchor="middle" font-size="14" font-weight="bold">Hidden States</text>
                        <text x="200" y="57" text-anchor="middle" font-size="11" fill="#666">[seq_len, 2560]</text>

                        <!-- Skip Connection Line (Left) -->
                        <path d="M 60 40 L 60 820 L 100 820" class="skip-connection"/>
                        <line x1="200" y1="60" x2="60" y2="60" stroke="#4caf50" stroke-width="2"/>
                        <line x1="60" y1="60" x2="60" y2="40" stroke="#4caf50" stroke-width="2"/>

                        <!-- Arrow down -->
                        <line x1="200" y1="60" x2="200" y2="90" class="arrow"/>

                        <!-- Layer Norm 1 -->
                        <rect x="100" y="90" width="200" height="40" class="norm-box" rx="5"/>
                        <text x="200" y="110" text-anchor="middle" font-size="13" font-weight="bold">RMS Norm</text>
                        <text x="200" y="122" text-anchor="middle" font-size="10" fill="#666">eps=1e-6</text>

                        <!-- Arrow down -->
                        <line x1="200" y1="130" x2="200" y2="160" class="arrow"/>

                        <!-- Self-Attention Block -->
                        <rect x="80" y="160" width="240" height="280" class="attention-box" rx="5"/>
                        <text x="200" y="185" text-anchor="middle" font-size="14" font-weight="bold">Multi-Head Attention</text>

                        <!-- Q, K, V projections -->
                        <rect x="95" y="200" width="65" height="35" class="special-box" rx="3"/>
                        <text x="127" y="220" text-anchor="middle" font-size="11">Q Proj</text>
                        <text x="127" y="230" text-anchor="middle" font-size="9" fill="#666">+QNorm</text>

                        <rect x="167" y="200" width="65" height="35" class="special-box" rx="3"/>
                        <text x="200" y="220" text-anchor="middle" font-size="11">K Proj</text>
                        <text x="200" y="230" text-anchor="middle" font-size="9" fill="#666">+KNorm</text>

                        <rect x="240" y="200" width="65" height="35" fill="#e3f2fd" stroke="#2196f3" stroke-width="2" rx="3"/>
                        <text x="272" y="220" text-anchor="middle" font-size="11">V Proj</text>

                        <!-- MRoPE -->
                        <rect x="95" y="245" width="210" height="35" class="special-box" rx="3"/>
                        <text x="200" y="262" text-anchor="middle" font-size="11" font-weight="bold">Interleaved MRoPE</text>
                        <text x="200" y="272" text-anchor="middle" font-size="9" fill="#666">[24, 20, 20] (T,H,W)</text>

                        <!-- GQA Info -->
                        <rect x="95" y="290" width="210" height="35" fill="#e3f2fd" stroke="#2196f3" stroke-width="2" rx="3"/>
                        <text x="200" y="305" text-anchor="middle" font-size="11">Grouped Query Attention</text>
                        <text x="200" y="315" text-anchor="middle" font-size="9" fill="#666">32 Q : 8 KV (4:1)</text>

                        <!-- Attention Computation -->
                        <rect x="95" y="335" width="210" height="35" fill="#e3f2fd" stroke="#2196f3" stroke-width="2" rx="3"/>
                        <text x="200" y="355" text-anchor="middle" font-size="11">Softmax(QK^T/âˆšd)V</text>
                        <text x="200" y="365" text-anchor="middle" font-size="9" fill="#666">d=80 (2560/32)</text>

                        <!-- Output projection -->
                        <rect x="95" y="380" width="210" height="35" fill="#e3f2fd" stroke="#2196f3" stroke-width="2" rx="3"/>
                        <text x="200" y="400" text-anchor="middle" font-size="11">Output Projection</text>
                        <text x="200" y="410" text-anchor="middle" font-size="9" fill="#666">2560 â†’ 2560</text>

                        <!-- Arrow down -->
                        <line x1="200" y1="440" x2="200" y2="470" class="arrow"/>

                        <!-- Residual Add 1 -->
                        <circle cx="200" cy="480" r="15" fill="white" stroke="#4caf50" stroke-width="2"/>
                        <text x="200" y="485" text-anchor="middle" font-size="20" fill="#4caf50">+</text>

                        <!-- Skip connection from input to residual -->
                        <path d="M 60 480 L 185 480" class="skip-connection"/>

                        <!-- Arrow down -->
                        <line x1="200" y1="495" x2="200" y2="525" class="arrow"/>

                        <!-- DeepStack Injection (optional) -->
                        <rect x="80" y="525" width="240" height="50" class="special-box" rx="5" stroke-dasharray="5,5"/>
                        <text x="200" y="545" text-anchor="middle" font-size="12" font-weight="bold" fill="#ff5722">DeepStack Injection</text>
                        <text x="200" y="560" text-anchor="middle" font-size="10" fill="#666">(Early Layers Only)</text>

                        <!-- DeepStack arrow from side -->
                        <path d="M 40 550 L 80 550" class="deepstack-connection"/>
                        <text x="25" y="545" text-anchor="middle" font-size="9" fill="#ff5722">Vision</text>
                        <text x="25" y="555" text-anchor="middle" font-size="9" fill="#ff5722">Features</text>

                        <!-- Arrow down -->
                        <line x1="200" y1="575" x2="200" y2="605" class="arrow"/>

                        <!-- Layer Norm 2 -->
                        <rect x="100" y="605" width="200" height="40" class="norm-box" rx="5"/>
                        <text x="200" y="625" text-anchor="middle" font-size="13" font-weight="bold">RMS Norm</text>
                        <text x="200" y="637" text-anchor="middle" font-size="10" fill="#666">eps=1e-6</text>

                        <!-- Arrow down -->
                        <line x1="200" y1="645" x2="200" y2="675" class="arrow"/>

                        <!-- FFN Block -->
                        <rect x="80" y="675" width="240" height="120" class="mlp-box" rx="5"/>
                        <text x="200" y="700" text-anchor="middle" font-size="14" font-weight="bold">Feed Forward Network</text>

                        <!-- FFN Details -->
                        <rect x="95" y="715" width="210" height="30" fill="#f3e5f5" stroke="#9c27b0" stroke-width="1" rx="3"/>
                        <text x="200" y="732" text-anchor="middle" font-size="11">Gate: Linear(2560 â†’ 9728)</text>
                        <text x="200" y="742" text-anchor="middle" font-size="9" fill="#666">+ SiLU activation</text>

                        <rect x="95" y="755" width="210" height="30" fill="#f3e5f5" stroke="#9c27b0" stroke-width="1" rx="3"/>
                        <text x="200" y="772" text-anchor="middle" font-size="11">Down: Linear(9728 â†’ 2560)</text>
                        <text x="200" y="782" text-anchor="middle" font-size="9" fill="#666">gate(x) * up(x)</text>

                        <!-- Arrow down -->
                        <line x1="200" y1="795" x2="200" y2="810" class="arrow"/>

                        <!-- Residual Add 2 -->
                        <circle cx="200" cy="820" r="15" fill="white" stroke="#4caf50" stroke-width="2"/>
                        <text x="200" y="825" text-anchor="middle" font-size="20" fill="#4caf50">+</text>

                        <!-- Arrow down -->
                        <line x1="200" y1="835" x2="200" y2="850" class="arrow"/>

                        <!-- Output -->
                        <rect x="100" y="850" width="200" height="40" class="output-box" rx="5"/>
                        <text x="200" y="870" text-anchor="middle" font-size="14" font-weight="bold">Output</text>
                        <text x="200" y="882" text-anchor="middle" font-size="11" fill="#666">[seq_len, 2560]</text>
                    </svg>
                </div>

                <!-- Qwen2.5-VL Decoder Block -->
                <div class="decoder-block">
                    <div class="block-title qwen25-title">Qwen2.5-VL Decoder Layer</div>
                    <svg viewBox="0 0 400 900" xmlns="http://www.w3.org/2000/svg">
                        <!-- Input -->
                        <rect x="100" y="20" width="200" height="40" class="input-box" rx="5"/>
                        <text x="200" y="45" text-anchor="middle" font-size="14" font-weight="bold">Hidden States</text>
                        <text x="200" y="57" text-anchor="middle" font-size="11" fill="#666">[seq_len, 2048]</text>

                        <!-- Skip Connection Line (Left) -->
                        <path d="M 60 40 L 60 480 L 100 480" class="skip-connection"/>
                        <line x1="200" y1="60" x2="60" y2="60" stroke="#4caf50" stroke-width="2"/>
                        <line x1="60" y1="60" x2="60" y2="40" stroke="#4caf50" stroke-width="2"/>

                        <!-- Skip Connection Line 2 (for FFN) -->
                        <path d="M 40 500 L 40 820 L 100 820" class="skip-connection"/>
                        <line x1="200" y1="500" x2="40" y2="500" stroke="#4caf50" stroke-width="2"/>

                        <!-- Arrow down -->
                        <line x1="200" y1="60" x2="200" y2="90" class="arrow"/>

                        <!-- Layer Norm 1 -->
                        <rect x="100" y="90" width="200" height="40" class="norm-box" rx="5"/>
                        <text x="200" y="110" text-anchor="middle" font-size="13" font-weight="bold">RMS Norm</text>
                        <text x="200" y="122" text-anchor="middle" font-size="10" fill="#666">eps=1e-5</text>

                        <!-- Arrow down -->
                        <line x1="200" y1="130" x2="200" y2="160" class="arrow"/>

                        <!-- Self-Attention Block -->
                        <rect x="80" y="160" width="240" height="280" class="attention-box" rx="5"/>
                        <text x="200" y="185" text-anchor="middle" font-size="14" font-weight="bold">Multi-Head Attention</text>

                        <!-- Q, K, V projections -->
                        <rect x="95" y="200" width="65" height="35" fill="#e3f2fd" stroke="#2196f3" stroke-width="2" rx="3"/>
                        <text x="127" y="218" text-anchor="middle" font-size="11">Q Proj</text>
                        <text x="127" y="230" text-anchor="middle" font-size="9" fill="#666">16 heads</text>

                        <rect x="167" y="200" width="65" height="35" fill="#e3f2fd" stroke="#2196f3" stroke-width="2" rx="3"/>
                        <text x="200" y="218" text-anchor="middle" font-size="11">K Proj</text>
                        <text x="200" y="230" text-anchor="middle" font-size="9" fill="#666">2 heads</text>

                        <rect x="240" y="200" width="65" height="35" fill="#e3f2fd" stroke="#2196f3" stroke-width="2" rx="3"/>
                        <text x="272" y="218" text-anchor="middle" font-size="11">V Proj</text>
                        <text x="272" y="230" text-anchor="middle" font-size="9" fill="#666">2 heads</text>

                        <!-- MRoPE -->
                        <rect x="95" y="245" width="210" height="35" class="special-box" rx="3"/>
                        <text x="200" y="262" text-anchor="middle" font-size="11" font-weight="bold">Standard MRoPE</text>
                        <text x="200" y="272" text-anchor="middle" font-size="9" fill="#666">[16, 24, 24] (T,H,W)</text>

                        <!-- GQA Info -->
                        <rect x="95" y="290" width="210" height="35" class="special-box" rx="3"/>
                        <text x="200" y="305" text-anchor="middle" font-size="11">Grouped Query Attention</text>
                        <text x="200" y="315" text-anchor="middle" font-size="9" fill="#666">16 Q : 2 KV (8:1)</text>

                        <!-- Sliding Window -->
                        <rect x="95" y="335" width="210" height="35" class="special-box" rx="3"/>
                        <text x="200" y="350" text-anchor="middle" font-size="11" font-weight="bold">Sliding Window</text>
                        <text x="200" y="360" text-anchor="middle" font-size="9" fill="#666">32,768 tokens</text>

                        <!-- Output projection -->
                        <rect x="95" y="380" width="210" height="35" fill="#e3f2fd" stroke="#2196f3" stroke-width="2" rx="3"/>
                        <text x="200" y="400" text-anchor="middle" font-size="11">Output Projection</text>
                        <text x="200" y="410" text-anchor="middle" font-size="9" fill="#666">2048 â†’ 2048</text>

                        <!-- Arrow down -->
                        <line x1="200" y1="440" x2="200" y2="470" class="arrow"/>

                        <!-- Residual Add 1 -->
                        <circle cx="200" cy="480" r="15" fill="white" stroke="#4caf50" stroke-width="2"/>
                        <text x="200" y="485" text-anchor="middle" font-size="20" fill="#4caf50">+</text>

                        <!-- Arrow down -->
                        <line x1="200" y1="495" x2="200" y2="525" class="arrow"/>

                        <!-- Intermediate Hidden State -->
                        <rect x="100" y="525" width="200" height="40" class="output-box" rx="5" stroke-dasharray="3,3"/>
                        <text x="200" y="545" text-anchor="middle" font-size="12">Hidden States</text>
                        <text x="200" y="557" text-anchor="middle" font-size="10" fill="#666">(After Attention)</text>

                        <!-- Arrow down -->
                        <line x1="200" y1="565" x2="200" y2="605" class="arrow"/>

                        <!-- Layer Norm 2 -->
                        <rect x="100" y="605" width="200" height="40" class="norm-box" rx="5"/>
                        <text x="200" y="625" text-anchor="middle" font-size="13" font-weight="bold">RMS Norm</text>
                        <text x="200" y="637" text-anchor="middle" font-size="10" fill="#666">eps=1e-5</text>

                        <!-- Arrow down -->
                        <line x1="200" y1="645" x2="200" y2="675" class="arrow"/>

                        <!-- FFN Block -->
                        <rect x="80" y="675" width="240" height="120" class="mlp-box" rx="5"/>
                        <text x="200" y="700" text-anchor="middle" font-size="14" font-weight="bold">SwiGLU FFN</text>

                        <!-- FFN Details -->
                        <rect x="95" y="715" width="100" height="30" fill="#f3e5f5" stroke="#9c27b0" stroke-width="1" rx="3"/>
                        <text x="145" y="732" text-anchor="middle" font-size="10">Gate Proj</text>
                        <text x="145" y="742" text-anchor="middle" font-size="9" fill="#666">2048â†’11008</text>

                        <rect x="205" y="715" width="100" height="30" fill="#f3e5f5" stroke="#9c27b0" stroke-width="1" rx="3"/>
                        <text x="255" y="732" text-anchor="middle" font-size="10">Up Proj</text>
                        <text x="255" y="742" text-anchor="middle" font-size="9" fill="#666">2048â†’11008</text>

                        <rect x="95" y="755" width="210" height="30" fill="#f3e5f5" stroke="#9c27b0" stroke-width="1" rx="3"/>
                        <text x="200" y="772" text-anchor="middle" font-size="11">Down: Linear(11008 â†’ 2048)</text>
                        <text x="200" y="782" text-anchor="middle" font-size="9" fill="#666">SiLU(gate) * up</text>

                        <!-- Arrow down -->
                        <line x1="200" y1="795" x2="200" y2="810" class="arrow"/>

                        <!-- Residual Add 2 -->
                        <circle cx="200" cy="820" r="15" fill="white" stroke="#4caf50" stroke-width="2"/>
                        <text x="200" y="825" text-anchor="middle" font-size="20" fill="#4caf50">+</text>

                        <!-- Arrow down -->
                        <line x1="200" y1="835" x2="200" y2="850" class="arrow"/>

                        <!-- Output -->
                        <rect x="100" y="850" width="200" height="40" class="output-box" rx="5"/>
                        <text x="200" y="870" text-anchor="middle" font-size="14" font-weight="bold">Output</text>
                        <text x="200" y="882" text-anchor="middle" font-size="11" fill="#666">[seq_len, 2048]</text>
                    </svg>
                </div>
            </div>

            <!-- è¯¦ç»†å‚æ•°å¯¹æ¯”è¡¨ -->
            <h2 style="color: #1e3c72; margin-top: 40px; margin-bottom: 20px;">ğŸ“Š Decoder Block è¯¦ç»†å‚æ•°å¯¹æ¯”</h2>

            <table class="param-table">
                <thead>
                    <tr>
                        <th>ç»„ä»¶</th>
                        <th>å‚æ•°</th>
                        <th>Qwen3-VL-4B</th>
                        <th>Qwen2.5-VL-3B</th>
                        <th>å·®å¼‚è¯´æ˜</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background: #f0f8ff;">
                        <td rowspan="5"><strong>Normalization</strong></td>
                        <td>ç±»å‹</td>
                        <td>RMSNorm</td>
                        <td>RMSNorm</td>
                        <td>ç›¸åŒ</td>
                    </tr>
                    <tr style="background: #f0f8ff;">
                        <td>Epsilon</td>
                        <td>1e-6</td>
                        <td>1e-5</td>
                        <td>ç²¾åº¦ç•¥æœ‰å·®å¼‚</td>
                    </tr>
                    <tr style="background: #f0f8ff;">
                        <td>QK Norm</td>
                        <td>âœ… æœ‰</td>
                        <td>âŒ æ— </td>
                        <td>Qwen3é¢å¤–çš„ç¨³å®šæ€§ä¼˜åŒ–</td>
                    </tr>
                    <tr style="background: #f0f8ff;">
                        <td>ä½ç½®</td>
                        <td>Pre-LN</td>
                        <td>Pre-LN</td>
                        <td>éƒ½æ˜¯Pre-LayerNormç»“æ„</td>
                    </tr>
                    <tr style="background: #f0f8ff;">
                        <td>å‚æ•°é‡</td>
                        <td>2Ã—2560</td>
                        <td>2Ã—2048</td>
                        <td>ä¸hidden_sizeç›¸å…³</td>
                    </tr>

                    <tr>
                        <td rowspan="7"><strong>Attention</strong></td>
                        <td>Hidden Size</td>
                        <td>2560</td>
                        <td>2048</td>
                        <td>Qwen3æ›´å¤§çš„éšè—ç»´åº¦</td>
                    </tr>
                    <tr>
                        <td>Q Heads</td>
                        <td>32</td>
                        <td>16</td>
                        <td>Qwen3æ›´å¤šçš„æŸ¥è¯¢å¤´</td>
                    </tr>
                    <tr>
                        <td>KV Heads</td>
                        <td>8</td>
                        <td>2</td>
                        <td>éƒ½ä½¿ç”¨GQAä¼˜åŒ–</td>
                    </tr>
                    <tr>
                        <td>GQAæ¯”ä¾‹</td>
                        <td>4:1</td>
                        <td>8:1</td>
                        <td>Qwen2.5æ›´æ¿€è¿›çš„å‹ç¼©</td>
                    </tr>
                    <tr>
                        <td>Head Dim</td>
                        <td>80 (2560/32)</td>
                        <td>128 (2048/16)</td>
                        <td>Qwen2.5æ¯ä¸ªå¤´æ›´å¤§</td>
                    </tr>
                    <tr>
                        <td>Window</td>
                        <td>å…¨å±€æ³¨æ„åŠ›</td>
                        <td>32,768 tokens</td>
                        <td>Qwen2.5ä½¿ç”¨æ»‘åŠ¨çª—å£</td>
                    </tr>
                    <tr>
                        <td>å‚æ•°é‡</td>
                        <td>~26M</td>
                        <td>~17M</td>
                        <td>GQAå¤§å¹…å‡å°‘å‚æ•°</td>
                    </tr>

                    <tr style="background: #f0f8ff;">
                        <td rowspan="5"><strong>MRoPE</strong></td>
                        <td>ç±»å‹</td>
                        <td>Interleaved</td>
                        <td>Standard</td>
                        <td>ä¸åŒçš„æ’åˆ—æ–¹å¼</td>
                    </tr>
                    <tr style="background: #f0f8ff;">
                        <td>Section</td>
                        <td>[24, 20, 20]</td>
                        <td>[16, 24, 24]</td>
                        <td>ç»´åº¦åˆ†é…ä¸åŒ</td>
                    </tr>
                    <tr style="background: #f0f8ff;">
                        <td>æ¨¡å¼</td>
                        <td>THWTHW...</td>
                        <td>TTT...HHH...WWW</td>
                        <td>äº¤é”™ vs åˆ†å—</td>
                    </tr>
                    <tr style="background: #f0f8ff;">
                        <td>Theta</td>
                        <td>500,000</td>
                        <td>1,000,000</td>
                        <td>é¢‘ç‡åŸºæ•°ä¸åŒ</td>
                    </tr>
                    <tr style="background: #f0f8ff;">
                        <td>Max Pos</td>
                        <td>262,144</td>
                        <td>128,000</td>
                        <td>æœ€å¤§ä½ç½®ç¼–ç </td>
                    </tr>

                    <tr>
                        <td rowspan="6"><strong>FFN</strong></td>
                        <td>ç±»å‹</td>
                        <td>æ ‡å‡†FFN</td>
                        <td>SwiGLU</td>
                        <td>Qwen2.5ä½¿ç”¨é—¨æ§æœºåˆ¶</td>
                    </tr>
                    <tr>
                        <td>æ¿€æ´»å‡½æ•°</td>
                        <td>SiLU</td>
                        <td>SiLU</td>
                        <td>ç›¸åŒ</td>
                    </tr>
                    <tr>
                        <td>ä¸­é—´å±‚ç»´åº¦</td>
                        <td>9728</td>
                        <td>11008</td>
                        <td>Qwen2.5æ›´å®½çš„FFN</td>
                    </tr>
                    <tr>
                        <td>æ‰©å±•æ¯”ä¾‹</td>
                        <td>3.8x</td>
                        <td>5.4x</td>
                        <td>Qwen2.5æ›´å¤§çš„æ‰©å±•</td>
                    </tr>
                    <tr>
                        <td>è®¡ç®—å…¬å¼</td>
                        <td>down(act(up(x)))</td>
                        <td>down(act(gate)Ã—up)</td>
                        <td>SwiGLUå¢åŠ é—¨æ§</td>
                    </tr>
                    <tr>
                        <td>å‚æ•°é‡</td>
                        <td>~50M</td>
                        <td>~67M</td>
                        <td>SwiGLUéœ€è¦é¢å¤–çš„gate</td>
                    </tr>

                    <tr style="background: #f0f8ff;">
                        <td rowspan="3"><strong>ç‰¹æ®Šæœºåˆ¶</strong></td>
                        <td>DeepStack</td>
                        <td>âœ… æ—©æœŸå±‚æ³¨å…¥</td>
                        <td>âŒ æ— </td>
                        <td>Qwen3ç‹¬æœ‰çš„è§†è§‰å¢å¼º</td>
                    </tr>
                    <tr style="background: #f0f8ff;">
                        <td>å±‚ç±»å‹</td>
                        <td>å…¨éƒ¨æ ‡å‡†å±‚</td>
                        <td>Full + Sliding</td>
                        <td>Qwen2.5æ··åˆå±‚ç±»å‹</td>
                    </tr>
                    <tr style="background: #f0f8ff;">
                        <td>KV Cache</td>
                        <td>æ ‡å‡†å¤§å°</td>
                        <td>å‡å°‘87.5%</td>
                        <td>GQAä¼˜åŒ–å†…å­˜</td>
                    </tr>
                </tbody>
            </table>

            <!-- è®¡ç®—å…¬å¼ -->
            <div class="formula-box">
                <h3 style="color: #1e3c72; margin-bottom: 15px;">ğŸ”¬ å…³é”®è®¡ç®—å…¬å¼</h3>

                <h4 style="color: #666; margin-top: 20px;">1. Attentionè®¡ç®—</h4>
                <div class="formula">
                    <strong>Qwen3-VL:</strong><br>
                    Q = QNorm(XW_q), K = KNorm(XW_k), V = XW_v<br>
                    Q', K' = InterleavedMRoPE(Q, K)<br>
                    Attention(Q',K',V) = softmax(Q'K'^T/âˆš80)V<br>
                    <span style="color: #999;">// 32ä¸ªQå¤´, 8ä¸ªKVå¤´ (4:1 GQA)</span>
                </div>

                <div class="formula">
                    <strong>Qwen2.5-VL:</strong><br>
                    Q = XW_q, K = XW_k, V = XW_v<br>
                    Q', K' = StandardMRoPE(Q, K)<br>
                    Attention(Q',K',V) = WindowedSoftmax(Q'K'^T/âˆš128)V<br>
                    <span style="color: #999;">// 16ä¸ªQå¤´, 2ä¸ªKVå¤´ (8:1 GQA)</span>
                </div>

                <h4 style="color: #666; margin-top: 20px;">2. FFNè®¡ç®—</h4>
                <div class="formula">
                    <strong>Qwen3-VL:</strong><br>
                    FFN(x) = W_down(SiLU(W_up(x)))<br>
                    <span style="color: #999;">// 2560 â†’ 9728 â†’ 2560</span>
                </div>

                <div class="formula">
                    <strong>Qwen2.5-VL (SwiGLU):</strong><br>
                    FFN(x) = W_down(SiLU(W_gate(x)) âŠ™ W_up(x))<br>
                    <span style="color: #999;">// 2048 â†’ 11008Ã—2 â†’ 2048</span>
                </div>

                <h4 style="color: #666; margin-top: 20px;">3. å±‚è¾“å‡ºè®¡ç®—</h4>
                <div class="formula">
                    <strong>é€šç”¨å…¬å¼:</strong><br>
                    h' = h + Attention(LayerNorm(h))<br>
                    output = h' + FFN(LayerNorm(h'))<br>
                    <br>
                    <strong>Qwen3-VLç‰¹æ®Š:</strong><br>
                    å¦‚æœæ˜¯æ—©æœŸå±‚: h' = h' + DeepStackFeatures
                </div>
            </div>

            <!-- å…³é”®å·®å¼‚æ€»ç»“ -->
            <div class="feature-grid">
                <div class="feature-card">
                    <h3>ğŸ¯ Qwen3-VL è®¾è®¡é‡ç‚¹</h3>
                    <ul style="margin-top: 10px; padding-left: 20px; line-height: 1.8;">
                        <li><strong>QK Normalization</strong>: æå‡è®­ç»ƒç¨³å®šæ€§</li>
                        <li><strong>Interleaved MRoPE</strong>: æ›´å¥½çš„3Dä½ç½®ç¼–ç </li>
                        <li><strong>DeepStackæ³¨å…¥</strong>: å¤šå±‚æ¬¡è§†è§‰èåˆ</li>
                        <li><strong>4:1 GQA</strong>: å¹³è¡¡æ•ˆç‡ä¸è´¨é‡</li>
                        <li><strong>è¾ƒå°FFN</strong>: 9728ç»´ä¸­é—´å±‚</li>
                    </ul>
                </div>

                <div class="feature-card">
                    <h3>âš¡ Qwen2.5-VL è®¾è®¡é‡ç‚¹</h3>
                    <ul style="margin-top: 10px; padding-left: 20px; line-height: 1.8;">
                        <li><strong>8:1 GQA</strong>: æè‡´å†…å­˜ä¼˜åŒ–</li>
                        <li><strong>Sliding Window</strong>: é•¿åºåˆ—æ•ˆç‡</li>
                        <li><strong>SwiGLU FFN</strong>: æ›´å¼ºçš„éçº¿æ€§</li>
                        <li><strong>Standard MRoPE</strong>: è®¡ç®—æ•ˆç‡ä¼˜å…ˆ</li>
                        <li><strong>æ›´å¤§FFN</strong>: 11008ç»´æ‰©å±•</li>
                    </ul>
                </div>
            </div>

            <!-- ä»£ç ç¤ºä¾‹ -->
            <h2 style="color: #1e3c72; margin-top: 40px; margin-bottom: 20px;">ğŸ’» å…³é”®ä»£ç å®ç°</h2>

            <div class="code-snippet">
                <code><pre># Qwen3-VL Decoder Layer ä¼ªä»£ç 
class Qwen3VLDecoderLayer(nn.Module):
    def __init__(self, config):
        self.input_layernorm = RMSNorm(config.hidden_size, eps=1e-6)
        self.self_attn = Qwen3VLAttention(config)  # å¸¦QK Norm
        self.post_attention_layernorm = RMSNorm(config.hidden_size, eps=1e-6)
        self.mlp = Qwen3VLMLP(config)

    def forward(self, hidden_states, position_embeddings, deepstack_features=None):
        # Self Attention with residual
        residual = hidden_states
        hidden_states = self.input_layernorm(hidden_states)
        hidden_states = self.self_attn(
            hidden_states,
            position_embeddings=position_embeddings,  # Interleaved MRoPE
            use_qk_norm=True
        )
        hidden_states = residual + hidden_states

        # DeepStack Injection (if early layer)
        if deepstack_features is not None:
            hidden_states = hidden_states + deepstack_features

        # FFN with residual
        residual = hidden_states
        hidden_states = self.post_attention_layernorm(hidden_states)
        hidden_states = self.mlp(hidden_states)
        hidden_states = residual + hidden_states

        return hidden_states</pre></code>
            </div>

            <div class="code-snippet">
                <code><pre># Qwen2.5-VL Decoder Layer ä¼ªä»£ç 
class Qwen25VLDecoderLayer(nn.Module):
    def __init__(self, config, layer_idx):
        self.input_layernorm = RMSNorm(config.hidden_size, eps=1e-5)
        self.self_attn = Qwen25VLAttention(config, layer_idx)
        self.post_attention_layernorm = RMSNorm(config.hidden_size, eps=1e-5)
        self.mlp = Qwen25VLSwiGLU(config)
        self.attention_type = config.layer_types[layer_idx]  # 'full' or 'sliding'

    def forward(self, hidden_states, position_embeddings):
        # Self Attention with residual
        residual = hidden_states
        hidden_states = self.input_layernorm(hidden_states)

        if self.attention_type == 'sliding':
            # Use sliding window attention
            hidden_states = self.self_attn(
                hidden_states,
                position_embeddings=position_embeddings,  # Standard MRoPE
                sliding_window=32768
            )
        else:
            # Use full attention
            hidden_states = self.self_attn(
                hidden_states,
                position_embeddings=position_embeddings
            )

        hidden_states = residual + hidden_states

        # SwiGLU FFN with residual
        residual = hidden_states
        hidden_states = self.post_attention_layernorm(hidden_states)
        hidden_states = self.mlp(hidden_states)  # gate * up -> down
        hidden_states = residual + hidden_states

        return hidden_states</pre></code>
            </div>

            <!-- æ€§èƒ½å½±å“åˆ†æ -->
            <h2 style="color: #1e3c72; margin-top: 40px; margin-bottom: 20px;">ğŸ“ˆ æ€§èƒ½å½±å“åˆ†æ</h2>

            <div class="param-table" style="background: white;">
                <table class="param-table">
                    <thead>
                        <tr>
                            <th>æŒ‡æ ‡</th>
                            <th>Qwen3-VL</th>
                            <th>Qwen2.5-VL</th>
                            <th>å½±å“</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>æ¯å±‚è®¡ç®—é‡</strong></td>
                            <td>O(LÂ²Ã—2560)</td>
                            <td>O(WÃ—2048) (sliding)</td>
                            <td>Qwen2.5åœ¨é•¿åºåˆ—æ—¶æ›´é«˜æ•ˆ</td>
                        </tr>
                        <tr>
                            <td><strong>KV Cache/å±‚</strong></td>
                            <td>LÃ—2560Ã—8/32</td>
                            <td>LÃ—2048Ã—2/16</td>
                            <td>Qwen2.5å‡å°‘75%å†…å­˜</td>
                        </tr>
                        <tr>
                            <td><strong>å‚æ•°é‡/å±‚</strong></td>
                            <td>~76M</td>
                            <td>~84M</td>
                            <td>Qwen2.5 FFNæ›´å¤§</td>
                        </tr>
                        <tr>
                            <td><strong>æ¨ç†å»¶è¿Ÿ</strong></td>
                            <td>æ ‡å‡†</td>
                            <td>æ›´ä½ï¼ˆGQA+Windowï¼‰</td>
                            <td>Qwen2.5ä¼˜åŒ–æ›´å¥½</td>
                        </tr>
                        <tr>
                            <td><strong>è®­ç»ƒç¨³å®šæ€§</strong></td>
                            <td>æ›´å¥½ï¼ˆQK Normï¼‰</td>
                            <td>æ ‡å‡†</td>
                            <td>Qwen3æ›´ç¨³å®š</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>
</html>