"""
MoEä¸­çš„å½’ä¸€åŒ–æƒé‡è¯¦è§£
åŸºäºQwen3-VL-MoEçš„å®é™…ä»£ç 
"""

def explain_moe_routing_normalization():
    """
    è§£é‡ŠMoEè·¯ç”±æƒé‡å½’ä¸€åŒ–çš„è¿‡ç¨‹
    """

    print("=" * 80)
    print("MoEä¸­çš„å½’ä¸€åŒ–æƒé‡ï¼ˆNormalized Routing Weightsï¼‰è¯¦è§£")
    print("=" * 80)

    print("\nğŸ“ 1. å®Œæ•´çš„è·¯ç”±è¿‡ç¨‹")
    print("-" * 40)
    print("""
    åŸºäºQwen3-VL-MoEçš„ä»£ç ï¼ˆmodeling_qwen3_vl_moe.py:145-148ï¼‰:

    # Step 1: è®¡ç®—è·¯ç”±logits
    router_logits = self.gate(hidden_states)  # [batch*seq_len, num_experts=128]

    # Step 2: åº”ç”¨softmaxå¾—åˆ°æ¦‚ç‡åˆ†å¸ƒ
    routing_weights = F.softmax(router_logits, dim=-1)  # æ‰€æœ‰128ä¸ªä¸“å®¶çš„æ¦‚ç‡ï¼Œå’Œ=1.0

    # Step 3: é€‰æ‹©top-kä¸“å®¶ï¼ˆk=8ï¼‰
    routing_weights, router_indices = torch.topk(routing_weights, self.top_k, dim=-1)
    # routing_weights: [batch*seq_len, 8] - top-8ä¸ªä¸“å®¶çš„åˆ†æ•°
    # router_indices: [batch*seq_len, 8] - top-8ä¸ªä¸“å®¶çš„ç´¢å¼•

    # Step 4: ğŸ”¥ å½’ä¸€åŒ–top-kçš„æƒé‡ï¼ˆå…³é”®æ­¥éª¤ï¼ï¼‰
    routing_weights = routing_weights / routing_weights.sum(dim=-1, keepdim=True)
    """)

    print("\nğŸ” 2. ä¸ºä»€ä¹ˆéœ€è¦å½’ä¸€åŒ–ï¼Ÿ")
    print("-" * 40)
    print("""
    å…·ä½“ä¾‹å­è¯´æ˜ï¼š

    å‡è®¾softmaxå128ä¸ªä¸“å®¶çš„æ¦‚ç‡åˆ†å¸ƒï¼š
    â€¢ Expert 0: 0.15
    â€¢ Expert 1: 0.12
    â€¢ Expert 2: 0.08
    â€¢ Expert 3: 0.07
    â€¢ Expert 4: 0.06
    â€¢ Expert 5: 0.05
    â€¢ Expert 6: 0.04
    â€¢ Expert 7: 0.03
    â€¢ Expert 8-127: å‰©ä½™0.40ï¼ˆåˆ†æ•£åœ¨120ä¸ªä¸“å®¶ï¼‰
    â€¢ æ€»å’Œ: 1.00

    é€‰æ‹©Top-8åï¼š
    â€¢ åªä¿ç•™: [0.15, 0.12, 0.08, 0.07, 0.06, 0.05, 0.04, 0.03]
    â€¢ è¿™8ä¸ªçš„å’Œ: 0.60 < 1.0
    â€¢ ä¸¢å¤±äº†40%çš„æ¦‚ç‡è´¨é‡ï¼

    å½’ä¸€åŒ–åï¼š
    â€¢ [0.15/0.60, 0.12/0.60, 0.08/0.60, 0.07/0.60, 0.06/0.60, 0.05/0.60, 0.04/0.60, 0.03/0.60]
    â€¢ = [0.25, 0.20, 0.133, 0.117, 0.10, 0.083, 0.067, 0.05]
    â€¢ æ–°çš„å’Œ: 1.00 âœ“
    """)

    print("\nğŸ’¡ 3. å½’ä¸€åŒ–çš„æ•°å­¦æ„ä¹‰")
    print("-" * 40)
    print("""
    æ•°å­¦å…¬å¼ï¼š

    è®¾top-8çš„åŸå§‹æƒé‡ä¸º: W = [wâ‚, wâ‚‚, ..., wâ‚ˆ]
    å…¶ä¸­ Î£wáµ¢ = S < 1.0

    å½’ä¸€åŒ–å: W' = [wâ‚/S, wâ‚‚/S, ..., wâ‚ˆ/S]
    ç¡®ä¿ Î£W'áµ¢ = 1.0

    ä¾‹å¦‚ï¼š
    â€¢ åŸå§‹: [0.15, 0.12, 0.08, 0.07, 0.06, 0.05, 0.04, 0.03], å’Œ=0.60
    â€¢ å½’ä¸€åŒ–: æ¯ä¸ªå€¼ Ã· 0.60
    â€¢ ç»“æœ: [0.25, 0.20, 0.133, 0.117, 0.10, 0.083, 0.067, 0.05], å’Œ=1.00
    """)

    print("\nğŸ¯ 4. å®é™…å½±å“")
    print("-" * 40)
    print("""
    å½’ä¸€åŒ–æƒé‡çš„ä½œç”¨ï¼š

    1. **è¾“å‡ºå¹…åº¦æ­£ç¡®**ï¼š
       æœªå½’ä¸€åŒ–: output = 0.15Ã—Eâ‚ + 0.12Ã—Eâ‚‚ + ... + 0.03Ã—Eâ‚ˆ â‰ˆ 0.6Ã—æ­£å¸¸è¾“å‡º
       å½’ä¸€åŒ–å: output = 0.25Ã—Eâ‚ + 0.20Ã—Eâ‚‚ + ... + 0.05Ã—Eâ‚ˆ = 1.0Ã—æ­£å¸¸è¾“å‡º

    2. **æ¢¯åº¦ç¨³å®š**ï¼š
       â€¢ ä¿æŒæ¿€æ´»å€¼åœ¨åˆç†èŒƒå›´
       â€¢ é¿å…æ¢¯åº¦æ¶ˆå¤±ï¼ˆè¾“å‡ºå¤ªå°ï¼‰æˆ–çˆ†ç‚¸

    3. **ä¸“å®¶è´¡çŒ®åº¦å‡†ç¡®**ï¼š
       â€¢ å½’ä¸€åŒ–åæ›´å‡†ç¡®åæ˜ ç›¸å¯¹é‡è¦æ€§
       â€¢ Expert 1å 25%ï¼ˆ0.25ï¼‰ï¼Œè€Œä¸æ˜¯15%ï¼ˆ0.15ï¼‰

    4. **å±‚é—´ä¸€è‡´æ€§**ï¼š
       â€¢ æ¯å±‚è¾“å‡ºscaleä¸€è‡´
       â€¢ ä¾¿äºå †å å¤šå±‚
    """)

    print("\nğŸ“Š 5. å…·ä½“æ•°å€¼ç¤ºä¾‹")
    print("-" * 40)

    # æ¨¡æ‹Ÿè®¡ç®—
    print("æ¨¡æ‹Ÿä¸€ä¸ªtokené€šè¿‡MoEå±‚ï¼š")
    print("\nStep 1: Softmaxåçš„128ä¸ªä¸“å®¶åˆ†æ•°ï¼ˆç¤ºä¾‹å‰10ä¸ªï¼‰ï¼š")
    scores = [0.15, 0.12, 0.08, 0.07, 0.06, 0.05, 0.04, 0.03, 0.025, 0.02]
    for i, s in enumerate(scores):
        print(f"  Expert {i:3d}: {s:.3f}")
    print("  ...ï¼ˆå‰©ä½™118ä¸ªä¸“å®¶ï¼Œæ€»å’Œçº¦0.355ï¼‰")

    print(f"\næ‰€æœ‰128ä¸ªä¸“å®¶çš„æ¦‚ç‡å’Œ: 1.000")

    print("\nStep 2: é€‰æ‹©Top-8ä¸“å®¶ï¼š")
    top8 = scores[:8]
    top8_sum = sum(top8)
    print(f"  Top-8ä¸“å®¶: {top8}")
    print(f"  Top-8çš„å’Œ: {top8_sum:.3f}")

    print("\nStep 3: å½’ä¸€åŒ–Top-8ï¼š")
    normalized = [s/top8_sum for s in top8]
    print("  å½’ä¸€åŒ–åçš„æƒé‡ï¼š")
    for i, (orig, norm) in enumerate(zip(top8, normalized)):
        print(f"    Expert {i}: {orig:.3f} â†’ {norm:.3f} (Ã—{norm/orig:.2f})")

    print(f"\n  å½’ä¸€åŒ–åçš„å’Œ: {sum(normalized):.3f} âœ“")

    print("\n" + "=" * 80)
    print("ğŸ“ æ€»ç»“")
    print("-" * 40)
    print("""
    åœ¨Qwen3-VL-MoEä¸­ï¼š

    1. è·¯ç”±å™¨ï¼ˆRouterï¼‰ä¸ºæ¯ä¸ªtokenè®¡ç®—128ä¸ªä¸“å®¶çš„åˆ†æ•°
    2. Softmaxç¡®ä¿128ä¸ªåˆ†æ•°å’Œä¸º1.0
    3. é€‰æ‹©åˆ†æ•°æœ€é«˜çš„8ä¸ªä¸“å®¶ï¼ˆtop-8ï¼‰
    4. ğŸ”¥ è¿™8ä¸ªä¸“å®¶çš„åˆ†æ•°å’Œé€šå¸¸<1.0ï¼ˆå¦‚0.6ï¼‰
    5. å½’ä¸€åŒ–ï¼šå°†è¿™8ä¸ªåˆ†æ•°é™¤ä»¥å®ƒä»¬çš„å’Œ
    6. å½’ä¸€åŒ–åï¼Œ8ä¸ªä¸“å®¶çš„æƒé‡å’Œæ¢å¤ä¸º1.0

    æ ¸å¿ƒä»£ç ï¼ˆç¬¬148è¡Œï¼‰ï¼š
    routing_weights = routing_weights / routing_weights.sum(dim=-1, keepdim=True)

    è¿™ç¡®ä¿äº†æ— è®ºé€‰æ‹©å¤šå°‘ä¸“å®¶ï¼Œæœ€ç»ˆçš„åŠ æƒè¾“å‡ºéƒ½ä¿æŒæ­£ç¡®çš„å¹…åº¦ï¼
    """)

    print("=" * 80)


if __name__ == "__main__":
    explain_moe_routing_normalization()